<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoloTalk English</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: #f7f7fb;
      color: #222;
      padding: 16px;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
    }
    h1 {
      margin: 8px 0 6px;
      font-size: 28px;
    }
    .subtitle {
      margin: 0 0 16px;
      color: #555;
      line-height: 1.5;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      display: grid;
      gap: 14px;
    }
    .image-wrap {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #eef1f4;
      aspect-ratio: 16 / 9;
      position: relative;
    }
    .image-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .image-fallback {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 6px;
      color: #666;
      text-align: center;
      padding: 12px;
    }
    .image-fallback .main {
      font-size: 18px;
      font-weight: 700;
    }
    .image-fallback .sub {
      font-size: 13px;
    }
    .box {
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #ececec;
      background: #fafafa;
    }
    .answer-box {
      border-color: #dbeafe;
      background: #f8fbff;
    }
    .record-box {
      border-color: #fde68a;
      background: #fffbeb;
    }
    .label {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }
    .jp-text {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      line-height: 1.4;
    }
    .en-text {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      line-height: 1.5;
    }
    button {
      border: none;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .primary-btn {
      background: #111827;
      color: #fff;
    }
    .secondary-btn {
      background: #fff;
      color: #111827;
      border: 1px solid #d1d5db;
      font-weight: 600;
    }
    .danger-btn {
      background: #dc2626;
      color: #fff;
    }
    .success-btn {
      background: #059669;
      color: #fff;
    }
    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .tiny {
      color: #666;
      font-size: 12px;
    }
    .status {
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
      margin-top: 2px;
    }
    audio {
      width: 100%;
      margin-top: 8px;
    }
    @media (max-width: 480px) {
      .jp-text { font-size: 20px; }
      .en-text { font-size: 18px; }
      h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SoloTalk English</h1>
    <p class="subtitle">çŠ¶æ³ã‚’è¦‹ã¦ã€ã¾ãšè‡ªåˆ†ã§è‹±èªã§ç‹¬ã‚Šè¨€ã‚’è¨€ã£ã¦ã¿ã‚ˆã†</p>

    <div class="card">
      <div class="image-wrap">
        <img id="sceneImage" src="" alt="scene image" />
        <div id="imageFallback" class="image-fallback">
          <div class="main">ç”»åƒï¼ˆæº–å‚™ä¸­ï¼‰</div>
          <div class="sub" id="fallbackCategory">category: -</div>
        </div>
      </div>

      <div class="box">
        <div class="label">æ—¥æœ¬èª</div>
        <p id="jpText" class="jp-text"></p>
      </div>

      <!-- éŒ²éŸ³ã‚¨ãƒªã‚¢ -->
      <div class="box record-box">
        <div class="label">éŒ²éŸ³ï¼ˆã‚ãªãŸã®ç‹¬ã‚Šè¨€ï¼‰</div>
        <div class="button-row">
          <button id="recordBtn" class="success-btn">ğŸ™ï¸ è©±ã™ï¼ˆéŒ²éŸ³é–‹å§‹ï¼‰</button>
          <button id="stopBtn" class="danger-btn" disabled>â–  åœæ­¢</button>
          <button id="playBtn" class="secondary-btn" disabled>â–¶ å†ç”Ÿ</button>
        </div>
        <div id="recordStatus" class="status">éŒ²éŸ³å‰</div>
        <audio id="audioPlayer" controls style="display:none;"></audio>
      </div>

      <div id="answerArea">
        <button id="showAnswerBtn" class="primary-btn">ç­”ãˆã‚’è¦‹ã‚‹</button>
      </div>

      <div class="button-row">
        <button id="nextBtn" class="secondary-btn">ğŸ² æ¬¡ã¸ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</button>
      </div>

      <div class="tiny">â€» èª­ã¿ä¸Šã’ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°æ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦å£°ãŒé•ã„ã¾ã™ï¼‰</div>
      <div class="tiny">â€» éŒ²éŸ³ã¯ãƒ–ãƒ©ã‚¦ã‚¶/ç«¯æœ«ã«ã‚ˆã£ã¦æŒ™å‹•ãŒå°‘ã—ç•°ãªã‚Šã¾ã™</div>
    </div>
  </div>

  <script>
    const cards = [
      {
        id: 1,
        category: "daily",
        image: "./images/daily_01.png",
        jp: "ã‚‚ã†ã“ã‚“ãªæ™‚é–“ï¼",
        model_en: "It's already this late!"
      },
      {
        id: 2,
        category: "lunch",
        image: "./images/lunch_01.png",
        jp: "ãˆãƒ¼ã©ã‚Œã«ã—ã‚ˆã†ã‹ãªã€‚(ãƒ©ãƒ³ãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼)",
        model_en: "Hmm, which one should I get?"
      },
      {
        id: 3,
        category: "body",
        image: "./images/body_01.png",
        jp: "è‚©ã“ã‚ŠãŒã‚„ã°ã„ã€‚",
        model_en: "My shoulders are so stiff."
      },
      {
        id: 4,
        category: "tired",
        image: "./images/tired_01.png",
        jp: "çœ ã™ãã¦ãƒ¤ãƒã„ã€‚",
        model_en: "I'm so sleepy right now."
      },
      {
        id: 5,
        category: "train",
        image: "./images/train_01.png",
        jp: "ãƒã‚¸ã§åº§ã‚ŠãŸã„ã€‚(é›»è»Šã§)",
        model_en: "I really want to sit down."
      }
    ];

    let currentCard = null;
    let showAnswer = false;

    // éŒ²éŸ³é–¢é€£
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordedAudioURL = null;
    let currentStream = null;

    const sceneImage = document.getElementById("sceneImage");
    const imageFallback = document.getElementById("imageFallback");
    const fallbackCategory = document.getElementById("fallbackCategory");
    const jpText = document.getElementById("jpText");
    const answerArea = document.getElementById("answerArea");
    const nextBtn = document.getElementById("nextBtn");

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const playBtn = document.getElementById("playBtn");
    const recordStatus = document.getElementById("recordStatus");
    const audioPlayer = document.getElementById("audioPlayer");

    function getRandomCard(excludeId) {
      if (cards.length === 1) return cards[0];
      let next = cards[Math.floor(Math.random() * cards.length)];
      while (excludeId !== undefined && next.id === excludeId) {
        next = cards[Math.floor(Math.random() * cards.length)];
      }
      return next;
    }

    function speakText(text) {
      if (!("speechSynthesis" in window)) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      window.speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      utterance.rate = 0.95;
      utterance.pitch = 1.0;

      const voices = window.speechSynthesis.getVoices();
      const englishVoice =
        voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-us")) ||
        voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en"));

      if (englishVoice) utterance.voice = englishVoice;
      window.speechSynthesis.speak(utterance);
    }

    function renderAnswerArea() {
      if (!showAnswer) {
        answerArea.innerHTML = '<button id="showAnswerBtn" class="primary-btn">ç­”ãˆã‚’è¦‹ã‚‹</button>';
        document.getElementById("showAnswerBtn").addEventListener("click", () => {
          showAnswer = true;
          renderAnswerArea();
        });
        return;
      }

      answerArea.innerHTML = `
        <div class="box answer-box">
          <div class="label">ãŠæ‰‹æœ¬ã®è‹±æ–‡</div>
          <p class="en-text">${currentCard.model_en}</p>
          <div class="button-row" style="margin-top:10px;">
            <button id="speakBtn" class="secondary-btn">ğŸ”Š èª­ã¿ä¸Šã’</button>
            <button id="hideAnswerBtn" class="secondary-btn">éš ã™</button>
          </div>
        </div>
      `;

      document.getElementById("speakBtn").addEventListener("click", () => {
        speakText(currentCard.model_en);
      });

      document.getElementById("hideAnswerBtn").addEventListener("click", () => {
        showAnswer = false;
        renderAnswerArea();
      });
    }

    function renderCard() {
      jpText.textContent = currentCard.jp;

      fallbackCategory.textContent = "category: " + currentCard.category;
      imageFallback.style.display = "none";
      sceneImage.style.display = "block";
      sceneImage.src = currentCard.image;
      sceneImage.alt = currentCard.jp;

      sceneImage.onerror = () => {
        sceneImage.style.display = "none";
        imageFallback.style.display = "flex";
      };

      sceneImage.onload = () => {
        sceneImage.style.display = "block";
        imageFallback.style.display = "none";
      };

      renderAnswerArea();
    }

    function resetRecordingUI() {
      if (recordedAudioURL) {
        URL.revokeObjectURL(recordedAudioURL);
        recordedAudioURL = null;
      }
      audioPlayer.pause();
      audioPlayer.removeAttribute("src");
      audioPlayer.style.display = "none";
      playBtn.disabled = true;
      recordStatus.textContent = "éŒ²éŸ³å‰";
    }

    function stopStreamTracks() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
    }

    async function startRecording() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³æ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“ã€‚");
        return;
      }

      try {
        // å‰ã®éŒ²éŸ³ãŒã‚ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
        resetRecordingUI();
        recordedChunks = [];

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        currentStream = stream;

        let mimeType = "";
        if (window.MediaRecorder && MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
          mimeType = "audio/webm;codecs=opus";
        } else if (window.MediaRecorder && MediaRecorder.isTypeSupported("audio/webm")) {
          mimeType = "audio/webm";
        }

        mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
          if (event.data && event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          try {
            const blobType = recordedChunks[0]?.type || "audio/webm";
            const audioBlob = new Blob(recordedChunks, { type: blobType });
            recordedAudioURL = URL.createObjectURL(audioBlob);

            audioPlayer.src = recordedAudioURL;
            audioPlayer.style.display = "block";
            playBtn.disabled = false;
            recordStatus.textContent = "éŒ²éŸ³å®Œäº† âœ…ï¼ˆå†ç”Ÿã§ãã¾ã™ï¼‰";
          } catch (e) {
            console.error(e);
            recordStatus.textContent = "éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ";
          } finally {
            stopStreamTracks();
          }
        };

        mediaRecorder.onerror = (e) => {
          console.error(e);
          recordStatus.textContent = "éŒ²éŸ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          stopStreamTracks();
        };

        mediaRecorder.start();
        recordStatus.textContent = "éŒ²éŸ³ä¸­â€¦ è‹±èªã§ç‹¬ã‚Šè¨€ã‚’è©±ã—ã¦ã¿ã‚ˆã†";
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        playBtn.disabled = true;
      } catch (error) {
        console.error(error);
        if (error.name === "NotAllowedError") {
          alert("ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
        } else {
          alert("éŒ²éŸ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚HTTPSç’°å¢ƒï¼ˆGitHub Pagesï¼‰ã ã¨å‹•ãã‚„ã™ã„ã§ã™ã€‚");
        }
        recordStatus.textContent = "éŒ²éŸ³é–‹å§‹ã«å¤±æ•—";
      }
    }

    function stopRecording() {
      if (!mediaRecorder) return;

      if (mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }

      recordBtn.disabled = false;
      stopBtn.disabled = true;
      recordStatus.textContent = "éŒ²éŸ³åœæ­¢ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆä¸­â€¦";
    }

    function playRecording() {
      if (!audioPlayer.src) return;
      audioPlayer.play();
    }

    function nextRandomCard() {
      if ("speechSynthesis" in window) window.speechSynthesis.cancel();

      // éŒ²éŸ³ä¸­ãªã‚‰åœæ­¢
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      stopStreamTracks();

      currentCard = getRandomCard(currentCard ? currentCard.id : undefined);
      showAnswer = false;
      resetRecordingUI();
      renderCard();
    }

    // iPhoneç³»ã§éŸ³å£°ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ãŒé…ã„ã“ã¨ãŒã‚ã‚‹
    if ("speechSynthesis" in window) {
      window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
      };
    }

    recordBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);
    playBtn.addEventListener("click", playRecording);
    nextBtn.addEventListener("click", nextRandomCard);

    // åˆå›è¡¨ç¤º
    nextRandomCard();
  </script>
</body>
</html>
